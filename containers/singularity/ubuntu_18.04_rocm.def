Bootstrap: docker
From: rocm/dev-ubuntu-18.04

%environment
    export PATH=/usr/lib/ccache:$PATH:/opt/rocm/bin:/opt/rocm/profiler/bin:/opt/rocm/opencl/bin/x86_64

%post
    mkdir /build
    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    apt-get upgrade --no-install-recommends -y
    apt-get install --no-install-recommends -y software-properties-common
    apt-get install --no-install-recommends -y \
        build-essential \
        ccache \
        gfortran \
        openmpi-bin \
        libopenmpi-dev \
        libfftw3-dev \
        libjpeg-dev \
        libpng-dev \
        python-dev \
        python3-dev \
        libblas-dev \
        liblapack-dev \
        libhdf5-serial-dev \
        hdf5-tools \
        clang \
        git \
        dh-make \
        bzr-builddeb \
        gcc \
        g++ \
        python-pip \
        python3-pip \
        virtualenv \
        python-virtualenv \
        python3-virtualenv \
        python3-setuptools \
        python3-pkg-resources \
        texlive \
        bc \
        cmake \
        libvtk6-dev \
        libeigen3-dev \
        ssh \
        libproj-dev \
        texlive-latex-extra \
        python-pygments \
        libenchant-dev \
        libgsl0-dev \
        gsl-bin \
        xxd \
        ninja-build \
        doxygen \
        rsync \
        wget \
        curl \
        libnuma-dev \
        rocm-libs
    mv /bin/sh /bin/sh.orig
    ln -s /bin/bash /bin/sh

    export PATH=/usr/lib/ccache:$PATH:/opt/rocm/bin:/opt/rocm/profiler/bin:/opt/rocm/opencl/bin/x86_64
    git clone https://github.com/ROCmSoftwarePlatform/hipCUB.git
    mkdir hipCUB/build
    cd hipCUB/build
    CXX=hcc cmake -D BUILD_TEST=off ..
    make -j4
    make package
    make install
